[[custom-ssl]]
= Custom SSL Certificates

You can use custom certificates with {productname} and {productname} Proxy.

This section covers how to use a third party SSL certificate authority with a new {productname} installation, and replacing existing certificate with new custom certificates.

Before you begin, ensure you have:

* A certificate authority (CA) SSL public certificate
* An SSL server key
* An SSL server certificate

Your key and certificate files must be in PEM format.

The host name of the SSL keys and certificates must match the fully qualified host name of the machine you deploy them on.
You can configure the host name of the certificate by editing the ``X509v3 Subject Alternative Name`` section of the certificate itself.
You can also list multiple host names if your environment requires it.

If you want to use intermediate certificates, you need to merge the intermediate and root CA certificates into one file.
Ensure that the intermediate certificate comes first in the combined file.


== Custom Certificates for New Installations

By default, {productname} uses a self-signed certificate.
After you have completed the initial setup, you can replace the default certificate with a custom certificate.

.Procedure: Installing Custom Certificates on a New {productname} Server

. Install the {productname} Server according to the instructions in xref:installation:install-intro.adoc[].
. Complete the initial setup according to xref:installation:server-setup.adoc[].
. At the command prompt, point the SSL environment variables to the custom certificate file locations:
+
----
export CA_CERT=`path_to_CA_certificate_file`
export SERVER_KEY=`path_to_web_server_key`
export SERVER_CERT=`path_to_web_server_certificate`
----
. Complete {productname} setup:
+
----
yast2 susemanagersetup
----
+
When you are prompted for certificate details during setup, fill in random values.
The values will be overridden by the values you specified at the command prompt.

[NOTE]
====
Execute the [command]``yast2 susemanagersetup`` command from the same shell you exported the environment variables from.
====


== Custom Certificates for New Proxy Installations

By default, {productname} Proxy uses a self-signed certificate.
After you have completed the initial setup, you can replace the default certificate with a custom certificate.

.Procedure: Installing Custom Certificates on a New {productname} Proxy

. Install the {productname} Proxy according to the instructions in xref:installation:install-intro.adoc[].
. Complete the initial setup according to xref:installation:proxy-setup.adoc[].
. At the command prompt, run:
+
----
configure-proxy.sh
----
. At the ``Do you want to import existing certificates?`` prompt, type kbd:[y]
. Follow the prompts to complete setup.



== Re-Create Existing Certificates

If your existing custom certificates have expired or stopped working for any reason, you can generate a new server certificate from the existing CA.

.Procedure: Re-Creating an Existing Certificate

. On the {productname} Server, at the command prompt, regenerate the server certificate:
+
----
rhn-ssl-tool --gen-server --dir="/root/ssl-build" --set-country="COUNTRY" \
--set-state="STATE" --set-city="CITY" --set-org="ORGANIZATION" \
--set-org-unit="ORGANIZATION UNIT" --set-email="name@example.com" \
--set-hostname="susemanager.example.top" --set-cname="example.com"
----
Ensure that the [systemitem]``set-cname`` parameter is the fully-qualified domain name of your {productname} Server.
You can use the the [systemitem]``set-cname`` parameter multiple times if you require multiple aliases.
. Install the RPM that contains the newly generated certificate.
Check that you have the latest version of the RPM before running this command.
The version number is incremented every time you re-create the certificates.
+
----
rpm -Uhv /root/ssl-build/lnx0259a/rhn-org-httpd-ssl-key-pair-lnx0259a-1.0-2.noarch.rpm
----
. Restart services to pick up the changes:
+
----
spacewalk-service restart
----



== Create New Certificates

If you need to create entirely new certificates for an existing installation, you will need to delete the old certificates before you begin.

[IMPORTANT]
====
Be careful with this procedure!
It is possible to break the trust chain between the server and clients using this procedure.
If that happens, you will need an administrative user to log in to every client and deploy the CA directly.
====



.Procedure: Creating New Certificates

. On the {productname} Server, at the command prompt, move the old certificate directory to a new location:
+
----
mv /root/ssl-build /root/old-ssl-build
----
. Generate a new CA certificate and create an RPM:
+
----
rhn-ssl-tool --gen-ca --dir="/root/ssl-build" --set-country="COUNTRY" \
--set-state="STATE" --set-city="CITY" --set-org="ORGANIZATION" \
--set-org-unit="ORGANIZATION UNIT" --set-common-name="SUSE Manager CA Certificate" \
--set-email="name@example.com"
----
. Generate a new server certificate and create an RPM:
+
----
rhn-ssl-tool --gen-server --dir="/root/ssl-build" --set-country="COUNTRY" \
--set-state="STATE" --set-city="CITY" --set-org="ORGANIZATION" \
--set-org-unit="ORGANIZATION UNIT" --set-email="name@example.com" \
--set-hostname="susemanager.example.top" --set-cname="example.com"
----
Ensure that the [systemitem]``set-cname`` parameter is the fully-qualified domain name of your {productname} Server.
You can use the the [systemitem]``set-cname`` parameter multiple times if you require multiple aliases.
+
You will need to generate a server certificate RPM for each proxy, using their host names and cnames.
. Create a new CA file that combines the old and new certificate details, and generate a new RPM:
+
----
mkdir /root/combined-ssl-build
cp /root/old-ssl-build/RHN-ORG-TRUSTED-SSL-CERT /root/combined-ssl-build/
cat /root/ssl-build/RHN-ORG-TRUSTED-SSL-CERT >> /root/combined-ssl-build/RHN-ORG-TRUSTED-SSL-CERT
cp /root/old-ssl-build/*.rpm /root/combined-ssl-build/
rhn-ssl-tool --gen-ca --rpm-only --dir="/root/combined-ssl-build"
----
// I would like to split up these steps, I think. LKB 2019-09-10
. Deploy the CA certificate on the server:
+
----
/usr/bin/rhn-deploy-ca-cert.pl --source-dir /root/combined-ssl-build \
--target-dir /srv/www/htdocs/pub/ --trust-dir=/etc/pki/trust/anchors/
----

When you have completed this procedure, you can deploy the new certificate on your clients.


.Procedure: Deploying Certificates on Traditional Clients

. On the client, create a new custom channel using these details:
+
* Name: SSL-CA-Channel
* Label: ssl-ca-channel
* Parent Channel: <choose the parent channel of a clients>
* Summary: SSL-CA-Channel

+
For more on creating custom channels, see xref:administration:channel-management.adoc[].
. Upload the CA certificate RPM to the channel:
+
----
rhnpush -c ssl-ca-channel --nosig \
--ca-chain=/srv/www/htdocs/pub/RHN-ORG-TRUSTED-SSL-CERT \
/root/combined-ssl-build/rhn-org-trusted-ssl-cert-1.0-2.noarch.rpm
----
. Subscribe all clients to the new ``SSL-CA-Channel`` channel.
. Install the CA certificate RPM on all clients by updating the channel.

.Procedure: Deploying Certificates on Salt Clients

// Does the above procedure also work for Salt? LKB 2019-09-10

. On the client, in the {productname} {webui}, navigate to menu:Salt[Remote Commands].
. In the first field, enter [guimenu]``salt-call state.apply certs``.
In the second field, after the ``@``, enter [guimenu]``*``.
Click btn:[Find Targets].
. Check that the appropriate clients are displayed, and click btn:[Run Command] to deploy the certificates on the clients.

image::deploy_cert_salt.png[scaledwidth=80%]
